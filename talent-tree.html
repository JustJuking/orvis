<!DOCTYPE html>
<html lang="en">
<head>
<link rel="icon" type="image/png" href="favicon.png">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Orvis Unbound</title>
<link rel="stylesheet" href="style.css">
<style>

  .tn-desc ul {
  margin: 6px 0 0 16px;
  padding: 0;
}

.tn-desc li {
  margin-bottom: 3px;
  line-height: 1.4;
}
  
  /* ── POINT BAR ─────────────────────────────── */
  .point-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: linear-gradient(135deg, #2c1a0e, #4a2e10);
    border: 2px solid var(--gold);
    border-radius: 4px;
    padding: 12px 24px;
    margin-bottom: 28px;
    box-shadow: inset 0 2px 8px rgba(0,0,0,0.5), 0 2px 4px rgba(201,150,58,0.3);
    flex-wrap: wrap;
    gap: 12px;
  }

  .point-bar-left {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .point-label {
    font-family: 'Cinzel', serif;
    font-size: 0.8rem;
    color: var(--gold);
    letter-spacing: 0.1em;
    text-transform: uppercase;
  }

  .point-display {
    font-family: 'Cinzel', serif;
    font-size: 2rem;
    font-weight: 700;
    color: var(--gold-bright);
    text-shadow: 0 0 12px rgba(240,192,64,0.6);
    line-height: 1;
  }

  .point-sub {
    font-family: 'Crimson Text', serif;
    color: var(--gold);
    font-size: 0.9rem;
    opacity: 0.7;
  }

  .reset-btn {
    font-family: 'Cinzel', serif;
    font-size: 0.8rem;
    background: transparent;
    border: 1px solid rgba(180,60,60,0.6);
    color: #c44;
    padding: 6px 16px;
    cursor: pointer;
    border-radius: 2px;
    letter-spacing: 0.05em;
    transition: all 0.2s;
  }
  .reset-btn:hover { background: rgba(180,60,60,0.15); }

  /* ── SECTION HEADERS ───────────────────────── */
  .talent-section-label {
    font-family: 'Cinzel', serif;
    font-size: 0.9rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--ink-faded);
    margin: 24px 0 10px;
    padding-bottom: 6px;
    border-bottom: 1px solid rgba(139,96,16,0.2);
  }

  /* ── MAIN GRID CARDS ───────────────────────── */
  .featured-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
    margin-bottom: 8px;
  }

  .skills-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
  }

  @media (max-width: 700px) {
    .featured-grid { grid-template-columns: repeat(2, 1fr); }
    .skills-grid { grid-template-columns: repeat(2, 1fr); }
  }

  .talent-card {
    background: linear-gradient(145deg, #fdf5d8, var(--parchment));
    border: 1px solid rgba(124,79,196,0.18);
    border-radius: 3px;
    padding: 12px 14px;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 2px 2px 6px rgba(0,0,0,0.15);
    user-select: none;
  }

  .talent-card:hover {
    border-color: rgba(124,79,196,0.58);
    box-shadow: 0 6px 24px rgba(0,0,0,0.4), 0 0 12px rgba(124,79,196,0.08);
  }

  .talent-card.has-points {
    background: linear-gradient(135deg, var(--arcane-dim), #2a1a50);
    color: var(--gold-bright);
    border: 1px solid var(--arcane);
    box-shadow: 0 4px 20px rgba(0,0,0,0.5), inset 0 1px 0 rgba(176,122,255,0.15);
  }

  .tc-name {
    font-family: 'Cinzel', serif;
    font-size: 0.9rem;
    font-weight: 700;
    color: var(--ink);
    letter-spacing: 0.03em;
    margin-bottom: 4px;
  }

  .tc-spent {
    font-family: 'Crimson Text', serif;
    font-size: 0.8rem;
    font-style: italic;
    color: var(--ink-faded);
  }

  .tc-spent.nonzero {
    color: #d4a840;
    font-style: normal;
    font-weight: 600;
  }

  /* ── DETAIL VIEW ───────────────────────────── */
  #detailView { display: none; }

  .detail-header {
    text-align: center;
    margin-bottom: 24px;
  }

  .detail-title {
    font-family: 'Cinzel Decorative', serif;
    font-size: 1.6rem;
    font-weight: 700;
    color: var(--gold-bright);
    text-shadow: 0 0 24px rgba(242,192,69,0.5), 0 0 60px rgba(242,192,69,0.18), 0 2px 4px rgba(0,0,0,0.9);
    letter-spacing: 0.05em;
    margin-bottom: 4px;
  }

  .detail-subtitle {
    font-family: 'Crimson Text', serif;
    font-style: italic;
    color: var(--silver-dim);
    font-size: 1rem;
  }

  /* Tree layout */
  .tree-level {
    display: flex;
    justify-content: center;
    gap: 12px;
    margin-bottom: 0;
    flex-wrap: wrap;
    position: relative;
  }

  .tree-connector {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 32px;
    position: relative;
  }

  .tree-connector-fan {
    height: 32px;
    position: relative;
    display: flex;
    justify-content: center;
  }

  /* Tree nodes */
  .tree-node {
    position: relative;
    width: 200px;
    background: linear-gradient(145deg, #fdf5d8, var(--parchment));
    border: 1px solid rgba(124,79,196,0.18);
    border-radius: 3px;
    padding: 12px 14px;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 2px 2px 6px rgba(124,79,196,0.18);
    user-select: none;
  }

  .tree-node.base-node {
    width: 400px;
    text-align: center;
  }

  .tree-node.locked {
    opacity: 0.4;
    cursor: not-allowed;
    filter: grayscale(20%);
  }

  .tree-node.available {
    background: linear-gradient(145deg, #fdf5d8, var(--parchment));
    border: 1px solid rgba(124,79,196,0.18);
    box-shadow: 2px 2px 6px rgba(124,79,196,0.18);
    cursor: pointer;
  }

  .tree-node.available:hover {
    border-color: rgba(124,79,196,0.58);
    box-shadow: 0 6px 24px rgba(0,0,0,0.4), 0 0 12px rgba(124,79,196,0.08);
    transform: translateY(-1px);
  }

  .tree-node.purchased {
    background: linear-gradient(135deg, var(--arcane-dim), #2a1a50);
    color: var(--gold-bright);
    border: 1px solid var(--arcane);
    box-shadow: 0 4px 20px rgba(0,0,0,0.5), inset 0 1px 0 rgba(176,122,255,0.15);
  }

  .tree-node.finale-node {
    width: 400px;
    text-align: center;
  }

  .tn-label {
    font-family: 'Cinzel', serif;
    font-size: 0.9rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--arcane-glow);
    margin-bottom: 6px;
    display: block;
  }

  .tn-name {
    font-family: 'Cinzel', serif;
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--ink);
    margin-bottom: 6px;
    line-height: 1.2;
  }

  .tn-desc {
    font-family: 'Crimson Text', serif;
    font-size: 1rem;
    color: var(--ink-light);
    line-height: 1.5;
  }

  .tn-cost {
    display: inline-block;
    font-family: 'Cinzel', serif;
    font-size: 0.8rem;
    color: var(--arcane);
    background: rgba(44,26,14,0.07);
    border: 1px solid rgba(124,79,196,0.18);
    border-radius: 3px;
    padding: 2px 8px;
    margin-top: 8px;
  }

  .tree-node.purchased .tn-cost { color: var(--arcane-glow); }
  .tree-node.locked .tn-cost { color: var(--arcane); }

  .tier-label {
    font-family: 'Crimson Text', serif;
    font-size: 0.9rem;
    font-style: italic;
    color: var(--ink-faded);
    text-align: center;
    margin: 4px 0 8px;
    opacity: 0.7;
  }

  .back-btn-row {
    display: flex;
    justify-content: center;
    margin-top: 32px;
  }

  /* ── PROFICIENCY PANEL ────────────────────────── */
  .prof-panel {
    padding: 14px 18px;
    margin-bottom: 20px;
  }

  .prof-panel-label {
    font-family: 'Cinzel', serif;
    font-size: 0.8rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--ink-faded);
    margin-bottom: 12px;
  }

  .prof-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    justify-content: center;
  }

  .prof-chip {
    display: flex;
    align-items: center;
    gap: 6px;
    font-family: 'Cinzel', serif;
    font-size: 0.9rem;
    color: var(--gold-bright);
    background: linear-gradient(135deg, var(--arcane-dim), #2a1a50);
    border: 1px solid var(--arcane);
    border-radius: 3px;
    padding: 8px 12px;
    cursor: pointer;
    user-select: none;
    transition: all 0.2s;
  }

  .prof-chip:hover {
    background: linear-gradient(135deg, var(--arcane), #3a2060);
    box-shadow: 0 0 8px rgba(201,150,58,0.3);
    transform: translateY(-2px);
    color: var(--gold-bright);
  }

  .prof-chip.active {
    background: linear-gradient(135deg, var(--arcane-dim), #2a1a50);
    border-color: var(--arcane-glow);
    color: var(--gold-bright);
    box-shadow: 0 0 12px rgba(176,122,255,0.6), 0 0 24px rgba(124,79,196,0.3);
  }

  .prof-chip input[type=checkbox] {
    accent-color: var(--arcane-glow);
    width: 13px;
    height: 13px;
    cursor: pointer;
  }

  /* ── BASE NODE FREE STYLING ─────────────────── */
  .tree-node.base-free {
    background: linear-gradient(135deg, var(--arcane-dim), #2a1a50);
    color: var(--gold-bright);
    border: 1px solid var(--arcane);
    box-shadow: 0 4px 20px rgba(0,0,0,0.5), inset 0 1px 0 rgba(176,122,255,0.15);
  }

  .refund-hint {
    text-align: center;
    font-family: 'Crimson Text', serif;
    font-style: italic;
    font-size: 0.82rem;
    color: var(--ink-faded);
    margin-top: 16px;
    opacity: 0.65;
  }

</style>
</head>
<body>

<div class="dir-bar">
  <a href="index.html" class="dir-home">Orvis Unbound</a>
  <a href="world.html" class="dir-pill">About Orvis</a>
  <a href="species.html" class="dir-pill">New Species</a>
  <a href="classes.html" class="dir-pill">New Classes</a>
  <a href="talent-tree.html" class="dir-pill">Talent Trees</a>
  <a href="point-buy.html" class="dir-pill">Point Buy</a>
  <a href="house-rules.html" class="dir-pill">House Rules</a>
  <a href="https://app.syrinscape.com/d3d373e5ef4d4d80a701418f53ae5462/player/" class="dir-end">Syrinscape</a>
</div>

<div class="page-wrapper">
  <div class="parchment fade-in">
    <span class="corner-ornament co-tl">❧</span>
    <span class="corner-ornament co-tr">❧</span>
    <span class="corner-ornament co-bl">❧</span>
    <span class="corner-ornament co-br">❧</span>

    <!-- ALWAYS-VISIBLE HEADER -->
    <h1 class="page-title">Pathways of Myth and Mastery</h1>
    <p class="page-subtitle">Specialize your skills to survive the wilds of Orvis.</p>
    <div class="ornament">⸻ ✦ ⸻</div>

<p class="welcome-drop-cap fade-in fade-in-delay-1">
Frostbitten wastes and crowded city sprawls make survival in Orvis require more than just basic training—it demands specialization. In this campaign, standard feats are replaced by custom Talent Trees. As your character faces the harsh realities of the world, they will earn Talent Points to spend across these branching paths. Whether you are mastering brutal martial techniques or refining volatile magic, these trees allow you to carve a unique path of mastery that reflects your character's personal journey and survival instincts.</p>

<hr class="hr-ornate">

<h2>How it Works</h2>
<p>You gain all the base feats of skills you are proficient in. You can apply proficiencies for your character below.<br>
You can use a feat point to gain proficiency with a skill.<br>
You can only put points in a skill tree if you are proficient with that skill. The core skill trees ( Armor & Shields, Magical Talents, Martial Talents, and Vitality) do not have this requirement.<br>
You gain 1 feat point every 2nd level (2,4,6 e.t.c).<br>
Instead of gaining an ASI, you may instead gain 1 additional feat point.<br>
Finale abilities (the capstone of a feat tree) cost 2 feat points and require at least one Tier 2 ability from that tree.</p>
    
<h2>A Bonus for Specialising</h2>
<p>If you have the finale and 2 completed branches in a tree, you gain the following benefit:<br>
<strong>Skill Talents:</strong> expertise with the skill (or another skill that makes sense if you already have expertise).<br>
<strong>Armor & Shields:</strong> +1 to your AC<br>
<strong>Magical Talents:</strong> +1 to SDC<br>
<strong>Martial Talents:</strong> +1 to attacks<br>
<strong>Vitality:</strong> +1 hit point per level</p>
    
    <!-- PROFICIENCY PANEL -->
    <div class="prof-panel" id="profPanel">
      <div class="prof-panel-label">Skill Proficiencies — tick any skill your character is proficient in. These base talents will be unlocked</div>
      <div class="prof-grid" id="profGrid"></div>
    </div>

    <!-- POINT BAR (always visible) -->
    <div class="point-bar">
      <div class="point-bar-left">
        <span class="point-label">Points Spent</span>
        <span class="point-display" id="globalSpent">0</span>
        <span class="point-sub" id="globalSub">across all trees</span>
      </div>
      <button class="reset-btn" onclick="resetAll()">✕ Reset All Talents</button>
    </div>

    <!-- MAIN VIEW -->
    <div id="mainView">
      <div class="talent-section-label">Core Talents</div>
      <div class="featured-grid" id="featuredGrid"></div>

      <div class="talent-section-label">Skill Talents</div>
      <div class="skills-grid" id="skillsGrid"></div>
    </div>

    <!-- DETAIL VIEW -->
    <div id="detailView">
      <div class="detail-header">
        <div class="detail-title" id="detailTitle"></div>
        <div class="detail-subtitle" id="detailSubtitle"></div>
      </div>

      <div id="treeArea"></div>

      <p class="refund-hint">Click a purchased talent to refund it · Locked talents cannot be selected</p>

      <div class="back-btn-row">
        <button class="btn btn-primary" onclick="showMain()">← Return to All Talents</button>
      </div>
    </div>

  </div>
</div>

<script>
// ═══════════════════════════════════════════════
// TALENT DATA
// Each tree has: id, name, subtitle, type (featured/skill)
// nodes: base, tier1 (array), tier2 (array, each linked to one tier1 by branch),
//        finale (unlocked when any tier2 purchased)
// ═══════════════════════════════════════════════

const TREES = [
  // ── CORE / FEATURED ──────────────────────────
  {
    id: 'armorshields', name: 'Armor & Shields', subtitle: 'Turn yourself into a walking fortress against teeth and blades.', type: 'featured',
    base: { name: 'Basic Training', desc: 'You gain proficiency with armor or improve your existing armor proficiencies. You can take this talent multiple times. You gain proficiency with light armor. If you already have proficiency in light armor, you also gain proficiency in medium armor and shields. If you already have proficiency in medium armor, you also gain proficiency in heavy armor. When you take this option, if you already have proficiency with the armor you desire, you can choose to progress again on this tree instead of gaining any armor proficiencies.' },
    tier1: [
      { id: 'armorshields-a', branch: 'a', name: 'Feather Step', desc: 'Creatures have Disadvantage on attacks of opportunity against you while you are wearing light or no armor.' },
      { id: 'armorshields-b', branch: 'b', name: 'Padded Plate', desc: 'Wearing light or medium armor doesn’t impose disadvantage on your Dexterity (Stealth) checks. Also, you can sleep in medium armor without penalty.' },
      { id: 'armorshields-c', branch: 'c', name: 'Built to Stand', desc: 'When you’re wearing heavy armor, you have advantage on contested checks and saving throws against effects which would knock you prone or push you and the distance you would be pushed is reduced by 10ft. When you are subjected to an effect which would corrode, rust, or otherwise damage your armor, you can use your reaction to prevent it from being affected' },
      { id: 'armorshields-d', branch: 'd', name: 'Shield Bash', desc: 'You can use a bonus action to try to shove a creature within 5 feet of you with your shield.' },
    ],
    tier2: [
      { id: 'armorshields-a2', branch: 'a', name: 'A Leaf in the Wind', desc: 'You can don and doff Light armor as an action and can wear it inconspicuously under normal clothes. While wearing light or no armor, you gain the following benefits: <ul style="margin:6px 0 0 16px; padding:0;"><li>You take half damage from opportunity attacks.</li><li>Your speed is increased by 5ft</li><li>You gain advantage on dexterity saving throws</li><li>Whenever a creature makes an opportunity attack against you, your speed increases by 5 feet until the end of the turn.</li></ul>' },
      { id: 'armorshields-b2', branch: 'b', name: 'Ready for Anything', desc: 'While wearing medium armor you gain the following benefits: <ul style="margin:6px 0 0 16px; padding:0;"><li>Your AC is increased by 1</li><li>You gain +1 to dexterity saving throws</li><li>During the first round of combat, your movement speed increases by 10ft and you gain resistance to the next source of damage you would take</li><li>Whenever you have disadvantage on an attack roll, saving throw, or ability check, you may choose to prevent the roll from being affected by disadvantage. Similarily, when a creature has advantage on an attack roll against you, you can prevent the roll from being affected by advantage. You may use this ability a number of times equal to your proficiency modifier, regaining all uses at the end of a long rest</li></ul>' },
      { id: 'armorshields-c2', branch: 'c', name: 'Bulwark', desc: '<ul style="margin:6px 0 0 16px; padding:0;"><li>While wearing heavy armor, Bludgeoning, Slashing and Piercing damage you take is reduced by your proficiency Modifier</li><li>Whenever a creature hits you with an attack, you can choose to halve the attack\'s damage against you. You may do this a number of times equal to your proficiency modifier, regaining all uses at the end of a long rest</li><li>You can sleep in armour without penalty</li></ul>' },
      { id: 'armorshields-d2', branch: 'd', name: 'Aegis Savant', desc: '<ul style="margin:6px 0 0 16px; padding:0;"><li>If you aren’t incapacitated, you can add your shield’s AC bonus to any shove attempts you make and to Dexterity saving throws you make against a spell or other harmful effect. If you fail the save you instead take half damage and if you would take half damage from a successful dexterity save, you instead take none</li><li>Whenever you successfully shove a creature with your shield, you may choose to deal bludgeoning damage to them equal to 1d6 + your shields AC</li><li>You can don and doff your shield as an object interaction during your turn</li></ul>' },
    ],
    finale: { name: 'Guardian Exemplar', desc: '<ul style="margin:6px 0 0 16px; padding:0;"><li>Armour you wear does not count against your encumberance</li><li>Your AC is increased by 1</li><li>Whenever a creature within 10ft of you is targeted with an attack, you can use your reaction to move to an unoccupied spot within 5ft of them and have the attack target you instead</li><li>During your turn you can choose to enter a defensive stance until the start of your next turn. While in this defensive stance, you and creatures of your choice within 10ft of you gain half cover. While in this defensive stance, provided you havent moved more than half your speed this turn, you can use a bonus action to increase the half cover to three quarter cover and set your speed to 0 until the start of your next turn. You may use this ability a number of times equal to your proficiency modifier, regaining 1 use at the end of a short rest and all uses at the ned of a long rest</li></ul>' }
  },
  {
    id: 'magical', name: 'Magical Talents', subtitle: 'Wrangle the unstable Weave to your will without losing your mind.', type: 'featured',
    base: { name: 'Arcane Sensitivity', desc: 'Your connection to the weave heightens your instincts. You can cast the Detect Magic spell once per long rest without expending a spell slot.' },
    tier1: [
      { id: 'magical-a', branch: 'a', name: 'Spell Sniper', desc: 'Your magical attacks find gaps in any defense. When you cast a spell that requires a ranged attack roll, the spell\'s range is doubled and it ignores half and three-quarters cover.' },
      { id: 'magical-b', branch: 'b', name: 'Ritual Caster', desc: 'You have learned to harness residual magical energy. You can cast any spell you know as a ritual if it has the ritual tag, without preparing it.' },
      { id: 'magical-c', branch: 'c', name: 'Arcane Recovery', desc: 'You can draw on latent magic to restore your power. Once per day during a short rest, you recover one expended spell slot of any level you can cast.' },
    ],
    tier2: [
      { id: 'magical-a2', branch: 'a', name: 'Empowered Magic', desc: 'When you roll damage for a spell, you can reroll a number of damage dice up to your spellcasting modifier (minimum 1). You must use the new results.' },
      { id: 'magical-b2', branch: 'b', name: 'Expanded Rituals', desc: 'Your ritual knowledge grows. You learn two additional spells with the ritual tag from any class list. These spells count as known for ritual casting only.' },
      { id: 'magical-c2', branch: 'c', name: 'Font of Magic', desc: 'Your magical reserves run deep. You gain bonus spell slots equal to half your proficiency bonus (rounded down) that replenish on a long rest.' },
    ],
    finale: { name: 'Arcane Sovereign', desc: 'Your mastery of the weave is unrivaled. Once per long rest, you can cast any spell you know or have prepared at its lowest level without expending a spell slot. Additionally, your spell save DC increases by 2 permanently.' }
  },
  {
    id: 'martial', name: 'Martial Talents', subtitle: 'Master the art of steel and blood to end fights quickly.', type: 'featured',
    base: { name: 'Combat Training', desc: 'Rigorous training has sharpened your instincts. You gain proficiency with one martial weapon of your choice, and your unarmed strikes deal 1d4 + Strength modifier bludgeoning damage.' },
    tier1: [
      { id: 'martial-a', branch: 'a', name: 'Duelist\'s Edge', desc: 'One-on-one combat is your domain. When you are fighting a creature and no other hostile creatures are within 5 feet of you, you gain a +2 bonus to attack rolls against that creature.' },
      { id: 'martial-b', branch: 'b', name: 'Brawler', desc: 'You fight with raw, vicious power. Your unarmed strikes deal 1d6 damage, and you can grapple as a bonus action after landing an unarmed strike.' },
      { id: 'martial-c', branch: 'c', name: 'Skirmisher', desc: 'You are most dangerous on the move. When you use the Dash action, you can make one weapon attack as a bonus action. Additionally, opportunity attacks against you are made with disadvantage.' },
    ],
    tier2: [
      { id: 'martial-a2', branch: 'a', name: 'Decisive Strike', desc: 'When you have advantage on an attack roll and hit, you can forgo advantage to instead deal extra damage equal to one roll of your weapon\'s damage die.' },
      { id: 'martial-b2', branch: 'b', name: 'Iron Grasp', desc: 'A creature you grapple cannot easily escape. Creatures grappled by you have disadvantage on their escape attempts, and you can use your grappled creature as half cover.' },
      { id: 'martial-c2', branch: 'c', name: 'Blitz', desc: 'You are a blur of controlled violence. When you take the Attack action, you can move up to half your speed between each attack without provoking opportunity attacks.' },
    ],
    finale: { name: 'Warlord', desc: 'Your martial presence reshapes the battlefield. Once per turn when you hit a creature with a weapon attack, you can choose one ally within 30 feet. That ally can immediately use their reaction to make one weapon attack. Additionally, you can make one additional attack whenever you use the Attack action.' }
  },
  {
    id: 'vitality', name: 'Vitality', subtitle: 'Push your body past it\'s physical limits to endure the killing blow.', type: 'featured',
    base: { name: 'Resilient Body', desc: 'Your body is hardened against punishment. You gain 2 hit points per character level (retroactive), and your hit point maximum increases by 2 for each level you gain hereafter.' },
    tier1: [
      { id: 'vitality-a', branch: 'a', name: 'Second Wind', desc: 'You can dig deep in the heat of battle. As a bonus action, you can regain hit points equal to 1d10 + your character level. You can use this once per short or long rest.' },
      { id: 'vitality-b', branch: 'b', name: 'Enduring Spirit', desc: 'Mental and physical strain cannot break you easily. You have advantage on saving throws against exhaustion, and the first level of exhaustion has no effect on you.' },
      { id: 'vitality-c', branch: 'c', name: 'Pain Threshold', desc: 'You can absorb punishment that would cripple others. When you receive damage that would reduce you below half your hit point maximum, you can use your reaction to reduce the damage by your Constitution modifier.' },
    ],
    tier2: [
      { id: 'vitality-a2', branch: 'a', name: 'Surge of Life', desc: 'Your recovery is legendary. When you use Second Wind, roll the die twice and take the higher result. You can also use Second Wind while incapacitated.' },
      { id: 'vitality-b2', branch: 'b', name: 'Unyielding', desc: 'You refuse to be broken. Once per long rest, when you fail a saving throw, you can choose to succeed instead.' },
      { id: 'vitality-c2', branch: 'c', name: 'Stalwart', desc: 'You are a wall that does not fall. When you are reduced to 0 hit points but not killed outright, you can drop to 1 hit point instead. You can use this once per long rest.' },
    ],
    finale: { name: 'Immortal Resolve', desc: 'Death itself hesitates before you. You have advantage on death saving throws. When you roll a natural 20 on a death saving throw, you regain consciousness with hit points equal to your Constitution modifier + your proficiency bonus. Additionally, your hit point maximum increases by 10.' }
  },

  // ── SKILLS ───────────────────────────────────
  {
    id: 'acrobatics', name: 'Acrobatics', subtitle: 'Maintain your balance, agility, and footing when the ground gives way.', type: 'skill',
    base: { name: 'Handspring', desc: 'Whenever you are knocked prone, you can use a reaction to immediately stand up.' },
    tier1: [
      { id: 'acro-a', branch: 'a', name: 'Making Tracks', desc: 'Whenever you take the dash action, you can move up to 10 additional feet and difficult terrain costs no extra movement this turn.' },
      { id: 'acro-b', branch: 'b', name: 'Tumbler', desc: 'When determining fall damage that would be dealt to you, treat any fall as if it were from 10 times your proficiency modifier in feet less than the actual height, to a minimum of 0 feet.' },
      { id: 'acro-c', branch: 'c', name: 'Nimble', desc: 'Whenever you take the dodge action, you also disengage and can move up to 10ft.' },
    ],
    tier2: [
      { id: 'acro-a2', branch: 'a', name: 'Untouchable', desc: '<ul style="margin:6px 0 0 16px; padding:0;"><li>Your speed increases by 10ft</li><li>Whenever you dash you can move along vertical surfaces and across liquids without falling during the move.</li><li>Whenever you make a melee attack against a creature, you can choose to move in such a way that distracts them causing the creature to strike out where they thought you were. Whether you hit or miss, the creature loses it\'s reaction and its speed is halved until the end of its next turn. You can do this a number of times equal to your proficiency modifier, regaining all uses at the end of a long rest.</li></ul>' },
      { id: 'acro-b2', branch: 'b', name: 'Parkour Mastery', desc: '<ul style="margin:6px 0 0 16px; padding:0;"><li>You can use a bonus action to attempt to dive through the space of a hostile creature that is within 5 feet of you. Make a Dexterity (Acrobatics) check vs. their Strength (Athletics) or Dexterity (Acrobatics) (their choice). You have advantage if they are larger than you. On a success, you move to a space of your choice within 5 feet of them, and the next attack against them has advantage.</li><li>You gain resistance to damage from falling, and always land on your feet when falling as long as you are conscious</li><li>When you are forced to move by a push, pull, or similar effect, you may redirect that movement up to 90 degrees from the original direction. If you do, you can move up to 10 feet farther than the original forced movement</li><li>You gain a climbing speed equal to your movement speed</li></ul>' },
      { id: 'acro-c2', branch: 'c', name: 'Reflexive Dodge', desc: '<ul style="margin:6px 0 0 16px; padding:0;"><li>During your turn, you can use all your movement to automatically escape from restraints and grapples</li><li>Whenever you succeed on a Dexterity saving throw you may move up to 10ft without provoking opportunity attacks. If you roll a natural 20 on it, you may instead move up to your movement speed</li><li>Whenever you would have to make a Strength saving throw, you can instead make a Dexterity saving throw, at advantage. You may do this a number of times equal to your proficiency modifier, regaining all uses on a long rest</li><li>Whenever a creature misses you with an attack, you can use your reaction to move up to half your speed without provoking opportunity attacks</li></ul>' },
    ],
    finale: { name: 'Agility Expert', desc: 'You master your body\'s movements, with grace and flair, gaining the following benefits: <ul style="margin:6px 0 0 16px; padding:0;"><li>You gain advantage on Initiative rolls</li><li>You may use your dexterity score instead of your strength score to determine your jumping height and distance</li><li>Creatures have disadvantage on attempts to grapple you</li><li>Whenever you use Handspring , you can move up to half your speed without provoking opportunity attacks</li><li>Standing up from prone uses only 5ft of movement</li><li>Whenever you fail a dexterity saving throw, you may choose to succeed on it instead. You may use this ability a number of times equal to your proficiency modifier, regaining all uses at the end of a long rest</li></ul>' }
  },
  {
    id: 'animal-handling', name: 'Animal Handling', subtitle: 'Calm beasts of burden and survive encounters with wild predators.', type: 'skill',
    base: { name: 'Beast Affinity', desc: 'Animals sense your calm intent. You gain proficiency in Animal Handling. Wild animals require a DC 5 lower check for you to calm or approach.' },
    tier1: [
      { id: 'anh-a', branch: 'a', name: 'Tame the Wild', desc: 'You can attempt to tame wild beasts. With 1 hour of work, you can attempt to domesticate a beast of CR 1 or lower that you have calmed. Make an Animal Handling check (DC 10 + beast CR × 5).' },
      { id: 'anh-b', branch: 'b', name: 'Mount Bond', desc: 'Your rapport with mounts is exceptional. You have advantage on all checks to control mounts, mounts bonded to you have +2 AC, and you can mount or dismount using only 5 feet of movement.' },
      { id: 'anh-c', branch: 'c', name: 'Beast Speech', desc: 'You can communicate simple concepts to any beast. Beasts understand your meaning clearly and can convey simple information back to you through behavior.' },
    ],
    tier2: [
      { id: 'anh-a2', branch: 'a', name: 'Pack Leader', desc: 'Beasts rally to your command. You can command up to three tamed beasts simultaneously as a single bonus action, and they gain +2 to attack and damage rolls while within 30 feet of you.' },
      { id: 'anh-b2', branch: 'b', name: 'War Rider', desc: 'You and your mount fight as one entity. Your mount can make one attack as part of your Attack action. Your mount also gains resistance to the first source of damage it takes each round.' },
      { id: 'anh-c2', branch: 'c', name: 'Primal Tongue', desc: 'You speak to beasts as kin. You can cast Speak with Animals at will without a spell slot. Beasts will answer your questions honestly and will not attack you unless magically compelled.' },
    ],
    finale: { name: 'Lord of Beasts', desc: 'The wild obeys your call. You can cast Conjure Animals (4th level) once per long rest without a spell slot. Beasts conjured this way are permanently loyal to you and do not disappear when the spell ends, though only one casting\'s worth of beasts can remain at a time.' }
  },
  {
    id: 'arcana', name: 'Arcana', subtitle: 'Understand the volatile Weave and the arcane forces that warp the world.', type: 'skill',
    base: { name: 'Scholarly Study', desc: 'Your study of arcane lore is extensive. You gain proficiency in Arcana. You can identify any spell being cast within 30 feet of you if you can see or hear it.' },
    tier1: [
      { id: 'arc-a', branch: 'a', name: 'Counterspell Intuition', desc: 'You can read the threads of a spell as it forms. When you use Counterspell, you automatically know the level of the spell you are attempting to counter.' },
      { id: 'arc-b', branch: 'b', name: 'Magical Analysis', desc: 'No enchantment is beyond your understanding. You can cast Identify as a ritual without material components, and the casting time is reduced to one action.' },
      { id: 'arc-c', branch: 'c', name: 'Lore Keeper', desc: 'Ancient magical knowledge flows through your mind. When you make an Arcana check, you can treat any roll of 9 or lower as a 10.' },
    ],
    tier2: [
      { id: 'arc-a2', branch: 'a', name: 'Spell Disruption', desc: 'You can sever magical connections. Once per short rest, you can attempt to dispel any magical effect you can see as an action (DC 10 + spell level). On a success, the effect ends.' },
      { id: 'arc-b2', branch: 'b', name: 'Enchanted Senses', desc: 'Magic reveals itself to you. You have advantage on all Arcana checks, and you can sense the presence of any active magical aura within 60 feet of you without concentration.' },
      { id: 'arc-c2', branch: 'c', name: 'Ancient Knowledge', desc: 'Your memory for arcane lore is encyclopedic. You automatically succeed on all Arcana checks with a passive DC of 20 or lower, and you add double your proficiency bonus to all Arcana checks.' },
    ],
    finale: { name: 'Arcane Sage', desc: 'The weave holds no secrets from you. You can cast Detect Magic and Identify at will. Once per long rest, you can perfectly reproduce any spell effect you have witnessed in the past 24 hours, casting it as if you knew it. It uses your spellcasting ability and counts as a spell of its lowest possible level.' }
  },
  {
    id: 'athletics', name: 'Athletics', subtitle: 'Rely on brute force and raw endurance to overcome physical obstacles.', type: 'skill',
    base: { name: 'Physical Conditioning', desc: 'Your body is a honed instrument of power. You gain proficiency in Athletics. Your carrying capacity and the weight you can push, drag, or lift doubles.' },
    tier1: [
      { id: 'ath-a', branch: 'a', name: 'Power Grappler', desc: 'You wrestle with crushing force. You have advantage on grapple checks, and creatures grappled by you have their speed reduced to 0. You can grapple creatures one size larger than you.' },
      { id: 'ath-b', branch: 'b', name: 'Leaping Charge', desc: 'You can cover enormous distances in a single bound. Your jump distance triples, and you do not need a running start for long or high jumps.' },
      { id: 'ath-c', branch: 'c', name: 'Powerful Build', desc: 'Your strength is extraordinary even among warriors. You count as one size larger for purposes of carrying capacity, grappling, and shove attempts.' },
    ],
    tier2: [
      { id: 'ath-a2', branch: 'a', name: 'Crusher', desc: 'Your grapples are devastating. While grappling a creature, you can use a bonus action to deal your Strength modifier in bludgeoning damage to it each turn. If you pin them (DC 15 Athletics), they are restrained.' },
      { id: 'ath-b2', branch: 'b', name: 'Momentum Strike', desc: 'Your charge carries devastating power. When you move at least 20 feet in a straight line before making a melee attack, that attack deals an extra 2d6 damage and the target must make a Strength saving throw (DC = 8 + proficiency + Strength) or be knocked prone.' },
      { id: 'ath-c2', branch: 'c', name: 'Titan Strength', desc: 'Your physical capabilities approach the mythic. You can attempt to lift and throw objects weighing up to 500 pounds. When you push, drag, or throw a creature or object, it travels up to 15 feet.' },
    ],
    finale: { name: 'Herculean', desc: 'Your physical might is legendary. You have advantage on all Athletics checks. Once per turn, when you hit a creature with a melee attack, you can attempt to shove them up to 15 feet in any direction as a free action. Creatures you shove take falling damage if thrown off an edge, and 2d6 bludgeoning damage if they collide with an object or creature.' }
  },
  {
    id: 'deception', name: 'Deception', subtitle: 'Spin the right lies to mask the truth and save your skin.', type: 'skill',
    base: { name: 'Silver Tongue', desc: 'Lies flow from you like honest words. You gain proficiency in Deception. When you tell a lie, creatures have disadvantage on Insight checks to detect it.' },
    tier1: [
      { id: 'dec-a', branch: 'a', name: 'Master of Disguise', desc: 'You can become anyone. Given one hour and appropriate materials, you can create a disguise so convincing that creatures who know the person need a DC 20 Insight check to see through it.' },
      { id: 'dec-b', branch: 'b', name: 'Double Agent', desc: 'You operate comfortably on all sides. You can maintain two separate false identities simultaneously without risk of confusing your stories, even under magical interrogation.' },
      { id: 'dec-c', branch: 'c', name: 'Misdirection', desc: 'You make people look where you want. As a bonus action, you can create a distraction that causes all creatures within 30 feet to briefly look away, granting you or one ally advantage on the next Stealth check made this turn.' },
    ],
    tier2: [
      { id: 'dec-a2', branch: 'a', name: 'Flawless Persona', desc: 'Your disguises are airtight. Your disguises hold up even against Detect Thoughts and Zone of Truth. You always know when a creature is magically attempting to read your mind or detect lies.' },
      { id: 'dec-b2', branch: 'b', name: 'Triple Cross', desc: 'Betrayal is an art form to you. Once per long rest, you can perfectly predict an enemy\'s planned action based on their tells. The DM tells you what action they will take next turn, and you have advantage on any check or saving throw directly related to countering it.' },
      { id: 'dec-c2', branch: 'c', name: 'Con Artist', desc: 'You can sell snow to the Soraki. You have advantage on all Deception checks, and creatures that fail a Deception-opposed check against you become Charmed by you for 1 minute.' },
    ],
    finale: { name: 'Faceless', desc: 'You have no true face — only the one you choose to show. You can cast Disguise Self at will and Seeming once per long rest without a spell slot. Under Zone of Truth, you are aware of the effect and can choose to remain silent rather than be compelled. You cannot be detected as a shapechanger by magical means.' }
  },
  {
    id: 'history', name: 'History', subtitle: 'Remember the forgotten lore, dead empires, and bloody past of Orvis.', type: 'skill',
    base: { name: 'Scholar\'s Mind', desc: 'Centuries of recorded knowledge fill your memory. You gain proficiency in History. When you succeed on a History check, you learn one additional piece of information beyond what was asked.' },
    tier1: [
      { id: 'his-a', branch: 'a', name: 'Tactical Historian', desc: 'You apply the lessons of past battles. When you succeed on a History check related to a creature type, you can advise your party: all allies gain a +2 bonus to AC against that creature type for 1 minute.' },
      { id: 'his-b', branch: 'b', name: 'Linguist', desc: 'History speaks in many tongues. You learn two additional languages of your choice. You can also attempt to understand unfamiliar languages with a DC 15 History check.' },
      { id: 'his-c', branch: 'c', name: 'Loremaster', desc: 'You never forget what you\'ve learned. You have advantage on all History checks. When you fail a History check, you can reroll it once.' },
    ],
    tier2: [
      { id: 'his-a2', branch: 'a', name: 'Strategic Mind', desc: 'You see the battlefield through the lens of a thousand campaigns. Once per combat, when initiative is rolled, you can grant one ally you can see an additional first-round action (attack, dash, hide, or cast a cantrip).' },
      { id: 'his-b2', branch: 'b', name: 'Polyglot', desc: 'Language is no barrier to you. You learn four additional languages and can attempt to communicate with any intelligent creature, even in languages you\'ve never encountered, with a DC 20 History check.' },
      { id: 'his-c2', branch: 'c', name: 'Sage', desc: 'Your knowledge spans every discipline. You gain proficiency in two other Intelligence-based skills of your choice, and you add double your proficiency bonus to History checks.' },
    ],
    finale: { name: 'Living Chronicle', desc: 'You have become a repository of all mortal knowledge. You automatically succeed on History checks with a passive DC of 25 or lower. Once per long rest, you can recall any historical fact, identify any creature, object, or spell, or know the general layout of any location you\'ve studied, with perfect accuracy.' }
  },
  {
    id: 'insight', name: 'Insight', subtitle: 'Read the true intentions of liars, allies, and desperate survivors.', type: 'skill',
    base: { name: 'Keen Intuition', desc: 'People are open books to you. You gain proficiency in Insight. When you succeed on an Insight check against a creature, you learn whether they are currently lying.' },
    tier1: [
      { id: 'ins-a', branch: 'a', name: 'Empathy', desc: 'You feel what others feel. You always know the current emotional state of any creature you are speaking with. You have advantage on Insight checks made to determine someone\'s motivation.' },
      { id: 'ins-b', branch: 'b', name: 'Tell Reader', desc: 'You spot the micro-expressions others miss. You can use Insight as a bonus action rather than an action, and your passive Insight is 5 higher than normal.' },
      { id: 'ins-c', branch: 'c', name: 'Gut Feeling', desc: 'Your instincts never lead you wrong. Once per short rest, you can ask the DM whether a course of action will lead to obvious immediate danger. The DM must answer honestly.' },
    ],
    tier2: [
      { id: 'ins-a2', branch: 'a', name: 'Heart Reader', desc: 'You can sense the deepest intentions of others. Once per long rest, you can cast Detect Thoughts without a spell slot. The target automatically fails their Wisdom saving throw against your first probing question.' },
      { id: 'ins-b2', branch: 'b', name: 'Unmasking Gaze', desc: 'Deception is futile under your scrutiny. You automatically succeed on Insight checks against creatures attempting to deceive you with a Deception modifier lower than your Insight modifier.' },
      { id: 'ins-c2', branch: 'c', name: 'Premonition', desc: 'Your danger sense borders on precognition. You cannot be surprised. At the start of combat, you can immediately move up to half your speed before initiative is rolled without provoking opportunity attacks.' },
    ],
    finale: { name: 'Oracle\'s Eye', desc: 'No mind is closed to you. You can cast Detect Thoughts at will without concentration. Once per long rest, you can sense the intended actions of all creatures within 30 feet for 1 minute — at the start of each of their turns, you know what action they intend to take.' }
  },
  {
    id: 'intimidation', name: 'Intimidation', subtitle: 'Bend others to your will through fear and the promise of violence.', type: 'skill',
    base: { name: 'Fearsome Presence', desc: 'Your bearing demands respect — or fear. You gain proficiency in Intimidation. Creatures that fail an Intimidation check against you remain shaken (disadvantage on their next attack roll) for 1 minute.' },
    tier1: [
      { id: 'int-a', branch: 'a', name: 'Unnerving Stare', desc: 'Your gaze alone can break resolve. As an action, you can force a creature within 30 feet to make a Wisdom saving throw (DC = 8 + proficiency + Charisma). On a failure, they are Frightened of you until the end of their next turn.' },
      { id: 'int-b', branch: 'b', name: 'Menacing', desc: 'You loom large in every room you enter. Creatures that fail Intimidation checks against you have disadvantage on attack rolls against you for 1 hour. You gain advantage on Intimidation checks against creatures smaller than you.' },
      { id: 'int-c', branch: 'c', name: 'Battle Cry', desc: 'Your war cry drives allies forward. As a bonus action, you can let out a terrifying cry. Allies within 30 feet gain advantage on their next attack roll, and enemies within 30 feet must succeed on a DC 13 Wisdom save or be Frightened until the end of your next turn.' },
    ],
    tier2: [
      { id: 'int-a2', branch: 'a', name: 'Terror', desc: 'One glance from you can shatter minds. Creatures Frightened by you have disadvantage on all saving throws, not just attack rolls. Creatures reduced below half health by your attacks must succeed on a DC 15 Wisdom save or become Frightened for 1 minute.' },
      { id: 'int-b2', branch: 'b', name: 'Crushing Dominance', desc: 'Your enemies know they cannot win. Creatures you have Intimidated cannot use the Help action to aid others against you, and they must spend their movement moving away from you on a failed Wisdom save (DC 8 + proficiency + Charisma) at the start of their turn.' },
      { id: 'int-c2', branch: 'c', name: 'Warcry Mastery', desc: 'Your cry echoes across any battlefield. Your Battle Cry now affects all allies within 60 feet and grants them temporary hit points equal to your Charisma modifier in addition to advantage on attacks.' },
    ],
    finale: { name: 'Lord of Fear', desc: 'Your presence alone reshapes the battlefield. At the start of combat, all enemy creatures within 30 feet must make a DC (8 + proficiency + Charisma) Wisdom saving throw or be Frightened of you for 1 minute. Frightened creatures that take damage from you must repeat the saving throw or become Paralyzed with fear until the end of their next turn.' }
  },
  {
    id: 'investigation', name: 'Investigation', subtitle: 'Deduce the truth from hidden clues left behind in the wreckage.', type: 'skill',
    base: { name: 'Analytical Mind', desc: 'You notice what others miss. You gain proficiency in Investigation. You can detect forgeries, secret doors, and hidden compartments automatically if they have a passive DC of 15 or lower.' },
    tier1: [
      { id: 'inv-a', branch: 'a', name: 'Crime Scene Analysis', desc: 'A scene speaks volumes to you. Given 10 minutes to examine a location where violence or crime occurred, you can reconstruct a precise account of what happened (who, how, approximately when) with a DC 15 Investigation check.' },
      { id: 'inv-b', branch: 'b', name: 'Deductive Reasoning', desc: 'Logic illuminates the unclear. When you have at least three clues related to a mystery, you can make a DC 15 Investigation check to determine a conclusion the DM confirms as accurate.' },
      { id: 'inv-c', branch: 'c', name: 'Trap Sense', desc: 'Danger announces itself to your trained eye. You have advantage on checks to detect traps, and your passive Investigation counts as 5 higher for the purpose of detecting hidden threats.' },
    ],
    tier2: [
      { id: 'inv-a2', branch: 'a', name: 'Infallible Memory', desc: 'Every detail is preserved perfectly. You can recall any detail you have previously examined with total accuracy. The DM cannot withhold information from you that your character would reasonably have observed.' },
      { id: 'inv-b2', branch: 'b', name: 'Master Detective', desc: 'The truth always surfaces for you. You have advantage on all Investigation checks. When you succeed on an Investigation check with a DC of 20 or higher, you gain one additional piece of information the DM considers most useful.' },
      { id: 'inv-c2', branch: 'c', name: 'Trap Expert', desc: 'You can dismantle any mechanism. You can disable magical traps as well as mundane ones. When you find a trap, you can trigger it safely from a distance of 30 feet using Investigation tools.' },
    ],
    finale: { name: 'The Mind\'s Eye', desc: 'No secret survives your scrutiny. You cannot be surprised. You automatically detect all hidden creatures, objects, and traps within 30 feet. Once per long rest, you can enter a heightened state of analysis for 1 minute: during this time, you automatically succeed on all Investigation checks and can see through any illusion or disguise.' }
  },
  {
    id: 'medicine', name: 'Medicine', subtitle: 'Stitch wounds, treat diseases, and keep your allies breathing.', type: 'skill',
    base: { name: 'Field Medic', desc: 'You can keep people alive where others cannot. You gain proficiency in Medicine. When you stabilize a dying creature, they regain 1 hit point instead of remaining unconscious.' },
    tier1: [
      { id: 'med-a', branch: 'a', name: 'Combat Medic', desc: 'You can heal in the heat of battle. As a bonus action, you can expend a healer\'s kit use to restore 1d6 + 4 hit points to a creature within 5 feet, and end one of the following conditions: blinded, deafened, or poisoned.' },
      { id: 'med-b', branch: 'b', name: 'Diagnostician', desc: 'You can determine exactly what ails any creature. With a 1-minute examination, you learn all diseases, poisons, and curses affecting a creature, their severity, and appropriate treatments.' },
      { id: 'med-c', branch: 'c', name: 'Herbalist', desc: 'Nature provides all the medicine you need. You can create healing poultices from natural materials with a 1-hour forage and preparation. Each poultice heals 2d4 + your Medicine modifier when applied.' },
    ],
    tier2: [
      { id: 'med-a2', branch: 'a', name: 'Emergency Response', desc: 'You work miracles under pressure. You can use Combat Medic as a free action once per round. Additionally, when you heal a creature that is below half hit points, they regain an additional 1d8 hit points.' },
      { id: 'med-b2', branch: 'b', name: 'Cure Anything', desc: 'No affliction is beyond your skill. Once per long rest, you can remove any single disease, curse, or poison from a creature through 10 minutes of treatment, without magical components.' },
      { id: 'med-c2', branch: 'c', name: 'Master Herbalist', desc: 'Your botanical knowledge is vast. You can create potions of healing in the field with 1 hour of work and a DC 12 Medicine check. You can create Superior Healing Potions with a DC 18 check.' },
    ],
    finale: { name: 'Miracle Worker', desc: 'Life itself answers to your skill. Once per long rest, over 10 minutes, you can restore a creature to full hit points, remove all conditions, and regain all expended Hit Dice. Additionally, your Combat Medic healing now also restores 1 expended spell slot of 1st or 2nd level to spellcasters.' }
  },
  {
    id: 'nature', name: 'Nature', subtitle: 'Read the unforgiving wilds and understand the beasts that claim them.', type: 'skill',
    base: { name: 'Child of the Wild', desc: 'The natural world is as familiar as your own skin. You gain proficiency in Nature. You can always find food and clean water in natural environments, and you can predict weather 24 hours in advance.' },
    tier1: [
      { id: 'nat-a', branch: 'a', name: 'Terrain Expert', desc: 'Every environment yields to your expertise. Choose two terrain types (arctic, coast, desert, forest, grassland, mountain, swamp, or underdark). In these terrains, your party never becomes lost, and you move at full speed through difficult terrain.' },
      { id: 'nat-b', branch: 'b', name: 'Toxinologist', desc: 'You understand nature\'s dangerous gifts. You can identify any plant, fungus, or natural toxin on sight. You have advantage on saving throws against natural poisons and disease, and you can apply natural toxins to weapons during a short rest.' },
      { id: 'nat-c', branch: 'c', name: 'Naturalist', desc: 'Plants and animals hold no mysteries. You have advantage on all Nature checks. When you encounter a creature, you can make a DC 10 Nature check to recall its key vulnerabilities, resistances, and abilities.' },
    ],
    tier2: [
      { id: 'nat-a2', branch: 'a', name: 'Master Tracker', desc: 'Your chosen terrain holds no secrets. In your chosen terrain types, you automatically succeed on all Survival checks to track creatures, and you can track creatures through magically obscured trails (DC 20 Nature check).' },
      { id: 'nat-b2', branch: 'b', name: 'Poison Crafter', desc: 'You can create deadly natural toxins. With one hour of work in a natural environment, you can create doses of: Paralytic Toxin (DC 15 Con, paralyzed 1 minute), or Weakening Poison (DC 13 Con, -2d6 to all damage for 10 minutes).' },
      { id: 'nat-c2', branch: 'c', name: 'One with Nature', desc: 'The wild responds to your presence. Animals never attack you unless commanded or provoked. Plants part to ease your passage. You have advantage on all checks when in natural environments.' },
    ],
    finale: { name: 'Lord of the Wild', desc: 'You are the apex of the natural world. You can speak with all natural creatures as if under Speak with Animals permanently. You can cast Commune with Nature once per long rest without a spell slot. Plants and animals within 60 feet will warn you of danger, granting you a passive Perception of 30 for the purpose of detecting threats in natural environments.' }
  },
  {
    id: 'perception', name: 'Perception', subtitle: 'Spot the ambush before the trap springs shut around you.', type: 'skill',
    base: { name: 'Watchful Eye', desc: 'Your senses are razor sharp. You gain proficiency in Perception. Your passive Perception increases by 3, and you cannot be surprised while you are conscious.' },
    tier1: [
      { id: 'per-a', branch: 'a', name: 'Eagle Eye', desc: 'Distance is no barrier to your sight. You can see clearly at twice the normal range in good conditions. You can read lips at up to 60 feet distance, and you spot visual details at distances that stagger others.' },
      { id: 'per-b', branch: 'b', name: 'Sound Sense', desc: 'You hear what others cannot. You have advantage on all Perception checks based on hearing. You can pinpoint the location of any creature making sound within 60 feet, even invisible ones.' },
      { id: 'per-c', branch: 'c', name: 'Alertness', desc: 'Your constant vigilance is exhausting to others, flawless in practice. You have advantage on initiative rolls. While on watch, you and your allies cannot be surprised.' },
    ],
    tier2: [
      { id: 'per-a2', branch: 'a', name: 'Hawkeye', desc: 'Your visual acuity approaches the supernatural. You can see through light obscurement (fog, dim light, light precipitation) without disadvantage. You spot hidden creatures with a passive Perception of 5 higher than normal.' },
      { id: 'per-b2', branch: 'b', name: 'Tremor Sense', desc: 'You feel the world through your feet. While standing on the ground, you sense the presence and location of all creatures touching the same ground within 30 feet of you, even if you cannot see or hear them.' },
      { id: 'per-c2', branch: 'c', name: 'Uncanny Awareness', desc: 'Your situational awareness is complete. You cannot be flanked. You are aware of all invisible creatures within 30 feet. You have advantage on all Perception checks.' },
    ],
    finale: { name: 'All-Seeing', desc: 'Your perception transcends mortal limits. You have blindsight out to 10 feet, and your passive Perception increases by an additional 5. You automatically detect all hidden creatures, invisible or otherwise, within 30 feet. You have advantage on initiative and can never be surprised while conscious.' }
  },
  {
    id: 'performance', name: 'Performance', subtitle: 'Captivate a room to earn a few coins or create a vital distraction.', type: 'skill',
    base: { name: 'Performer\'s Gift', desc: 'You command attention when you choose it. You gain proficiency in Performance. When you perform for at least 10 minutes, all creatures who witnessed it have their attitude toward you improve by one step for 1 hour.' },
    tier1: [
      { id: 'prf-a', branch: 'a', name: 'Bardic Inspiration', desc: 'Your words empower those around you. As a bonus action, you can grant one creature within 60 feet that can hear you a Bardic Inspiration die (1d6). They can add it to one ability check, attack roll, or saving throw in the next 10 minutes.' },
      { id: 'prf-b', branch: 'b', name: 'Captivating Presence', desc: 'An audience cannot look away. When you perform, creatures within 30 feet must succeed on a DC (8 + proficiency + Charisma) Wisdom save or be unable to take hostile actions against you until you stop performing or attack.' },
      { id: 'prf-c', branch: 'c', name: 'Master Entertainer', desc: 'Your performances are unforgettable. You have advantage on all Performance checks. After a successful performance, the venue\'s owner will offer you free lodging and meals for the night without question.' },
    ],
    tier2: [
      { id: 'prf-a2', branch: 'a', name: 'Inspiring Leader', desc: 'Your inspiration carries the weight of legend. Your Bardic Inspiration die improves to 1d8, and you can grant it to a number of creatures equal to your Charisma modifier simultaneously as one bonus action.' },
      { id: 'prf-b2', branch: 'b', name: 'Spellbound', desc: 'Your performance is almost magical in its power. Creatures who fail your Captivating Presence save are also Charmed by you for 1 hour after you stop performing. They become friendly and willing to answer reasonable questions.' },
      { id: 'prf-c2', branch: 'c', name: 'Living Legend', desc: 'Your reputation precedes you everywhere. In any populated area, there is a 50% chance an NPC recognizes you from a performance (or reputation). Recognized creatures begin with an initial attitude of Friendly.' },
    ],
    finale: { name: 'The Great Performance', desc: 'The world is your stage. Once per long rest, over the course of a 1-minute performance, you can affect all creatures within 60 feet who can see and hear you. Choose: grant all allies 20 temporary hit points and advantage on all checks for 1 hour; or force all enemies to make a DC (8 + proficiency + Charisma) Wisdom save or be Charmed and unable to take hostile actions for 1 minute.' }
  },
  {
    id: 'persuasion', name: 'Persuasion', subtitle: 'Charm, negotiate, and reason your way out of drawing a blade.', type: 'skill',
    base: { name: 'Compelling Voice', desc: 'People want to believe what you say. You gain proficiency in Persuasion. When you succeed on a Persuasion check, the creature\'s attitude toward you improves by an additional step, beyond what was asked.' },
    tier1: [
      { id: 'prs-a', branch: 'a', name: 'Negotiator', desc: 'You can always find common ground. You can make Persuasion checks to negotiate with creatures that would normally be hostile, as long as they can communicate. Creatures you negotiate with agree to a temporary truce for the duration of talks.' },
      { id: 'prs-b', branch: 'b', name: 'Inspiring Words', desc: 'Your words carry the weight of conviction. When you spend 1 minute addressing a creature on a specific topic, you can grant advantage on their next check related to that topic, lasting up to 1 hour.' },
      { id: 'prs-c', branch: 'c', name: 'Social Tactician', desc: 'You read social situations instantly. You always know the current attitude of any creature toward you and your party. You have advantage on Persuasion checks when you address a creature\'s stated concern or goal.' },
    ],
    tier2: [
      { id: 'prs-a2', branch: 'a', name: 'Master Negotiator', desc: 'No deal is beyond your reach. You can make Persuasion checks to negotiate with any intelligent creature, including those under magical compulsion to be hostile (though the DC increases by 10). Creatures bound by agreement cannot break it without first succeeding on a DC 20 Wisdom save.' },
      { id: 'prs-b2', branch: 'b', name: 'Rousing Speech', desc: 'Your words ignite action. After 1 minute of speech, all allies who heard it gain advantage on all checks for 1 hour and cannot be Frightened for the duration. Additionally, they have advantage on their next death saving throw.' },
      { id: 'prs-c2', branch: 'c', name: 'Diplomatic Immunity', desc: 'Your social mastery grants real protection. Creatures with an attitude of Friendly or better toward you will not take hostile actions against you unless magically compelled, and will warn you of threats to your safety.' },
    ],
    finale: { name: 'Voice of Command', desc: 'Words alone can move the world. Once per long rest, you can make a Persuasion check against any number of creatures who can hear you. On a success, they treat you as an trusted authority on whatever topic you address for 24 hours. They will follow reasonable requests and can be convinced to reveal secrets with a follow-up DC 15 Persuasion check.' }
  },
  {
    id: 'religion', name: 'Religion', subtitle: 'Recall knowledge of the gods, ancient myths, and celestial forces.', type: 'skill',
    base: { name: 'Devotee', desc: 'Your understanding of the divine transcends simple faith. You gain proficiency in Religion. You can recognize all divine symbols, rituals, and tenets of any religion you encounter, and you know how to appropriately address any divine servant.' },
    tier1: [
      { id: 'rel-a', branch: 'a', name: 'Divine Lore', desc: 'The histories of every faith are known to you. You have advantage on Religion checks. When you succeed on a Religion check, you learn one additional piece of information about the subject beyond what was asked.' },
      { id: 'rel-b', branch: 'b', name: 'Holy Ward', desc: 'Your faith provides real protection. You can spend 1 minute in prayer to grant yourself or one creature a ward of divine protection. The warded creature has advantage on saving throws against spells and abilities from undead, fiends, and celestials for 8 hours.' },
      { id: 'rel-c', branch: 'c', name: 'Turn the Tide', desc: 'Your invocation of divine power can repel darkness. As an action, you can present a holy symbol. Undead and fiends within 30 feet must succeed on a DC (8 + proficiency + Wisdom) Wisdom save or be Frightened of you for 1 minute.' },
    ],
    tier2: [
      { id: 'rel-a2', branch: 'a', name: 'Divine Scholar', desc: 'No religious secret is beyond your knowledge. You can identify the divine abilities, weaknesses, and divine portfolios of any deity, celestial, or fiend with a DC 15 Religion check. You add double your proficiency bonus to all Religion checks.' },
      { id: 'rel-b2', branch: 'b', name: 'Blessed Endurance', desc: 'Divine favor sustains you. You have resistance to radiant and necrotic damage. Once per long rest, when you or an ally within 30 feet would be reduced to 0 hit points, you can use your reaction to stabilize them at 1 hit point instead.' },
      { id: 'rel-c2', branch: 'c', name: 'Banishment', desc: 'You can send creatures back to their native planes. Once per long rest, you can attempt to banish a fiend or undead as an action. The creature must succeed on a DC (8 + proficiency + Wisdom) Charisma save or be banished to its home plane for 1 minute.' },
    ],
    finale: { name: 'Voice of the Divine', desc: 'The gods themselves acknowledge your devotion. Once per long rest, you can call for divine intervention. Roll percentile dice; on a result equal to or lower than your character level × 5, your deity intervenes in a meaningful way of the DM\'s choosing. Whether or not the roll succeeds, undead and fiends treat you as a sacred object — they must succeed on a DC 20 Wisdom save to take any hostile action against you.' }
  },
  {
    id: 'sleight-of-hand', name: 'Sleight of Hand', subtitle: 'Use quick fingers to take what you need or hide what you hold.', type: 'skill',
    base: { name: 'Nimble Fingers', desc: 'Your hands move with practiced precision. You gain proficiency in Sleight of Hand. You can perform simple tricks and palming at will without a check.' },
    tier1: [
      { id: 'soh-a', branch: 'a', name: 'Pickpocket', desc: 'Wealth has a way of finding its way to your pockets. You can attempt to steal an item from a creature\'s person as a bonus action, with advantage on the Sleight of Hand check if the creature is distracted or engaged with another creature.' },
      { id: 'soh-b', branch: 'b', name: 'Quick Draw', desc: 'Weapons appear in your hands like magic. You can draw or stow two weapons instead of one as part of your movement. You can also conceal small weapons on your person even during a casual search (DC 20 Perception to detect).' },
      { id: 'soh-c', branch: 'c', name: 'Lock Artist', desc: 'No lock is beyond your skill. You have advantage on checks to pick locks and disable devices. You can attempt to pick any non-magical lock in half the normal time.' },
    ],
    tier2: [
      { id: 'soh-a2', branch: 'a', name: 'Master Pickpocket', desc: 'You can steal the boots off a sleeping giant. You can steal items directly from a creature\'s hands or worn on their body without disadvantage, even during combat (as a bonus action on your turn).' },
      { id: 'soh-b2', branch: 'b', name: 'Hidden Arsenal', desc: 'You are never truly unarmed. You can conceal up to three weapons of any size on your person that cannot be detected by casual searching or detect magic. You have advantage on Sleight of Hand checks to draw hidden weapons.' },
      { id: 'soh-c2', branch: 'c', name: 'Master Infiltrator', desc: 'No security can hold you. You can pick magical locks with a DC 20 Sleight of Hand check. You can disarm magical traps as easily as mundane ones. You leave no trace of tampering unless a creature succeeds on a DC 25 Perception or Investigation check.' },
    ],
    finale: { name: 'Ghost Hands', desc: 'Your touch is imperceptible. You can steal any item from any creature without any chance of detection unless they succeed on a DC 25 Perception check. You can pick any lock, mundane or magical, in one action with advantage on the check. Once per long rest, you can make any item on your person vanish completely, undetectable by any means, reappearing when you choose.' }
  },
  {
    id: 'stealth', name: 'Stealth', subtitle: 'Move unseen and unheard to avoid the dangers lurking in the dark.', type: 'skill',
    base: { name: 'Shadow Step', desc: 'Shadows welcome you like old friends. You gain proficiency in Stealth. You can attempt to hide as a bonus action, and dim light does not impose disadvantage on your Stealth checks.' },
    tier1: [
      { id: 'ste-a', branch: 'a', name: 'Vanishing Act', desc: 'You can disappear in the blink of an eye. When you are in dim light or darkness, you can take the Hide action as a free action (no action required) once per turn.' },
      { id: 'ste-b', branch: 'b', name: 'Silent Movement', desc: 'You move without a whisper. You have advantage on all Stealth checks based on sound. Your movement never triggers noise-based traps or alarms.' },
      { id: 'ste-c', branch: 'c', name: 'Camouflage', desc: 'You blend into any environment. In natural environments, you have advantage on Stealth checks. You can remain hidden while moving at full speed without disadvantage.' },
    ],
    tier2: [
      { id: 'ste-a2', branch: 'a', name: 'One with Shadow', desc: 'You are indistinguishable from darkness. While hidden in dim light or darkness, you are invisible to darkvision. You can make Stealth checks even while under magical observation, with a DC equal to the spell\'s save DC.' },
      { id: 'ste-b2', branch: 'b', name: 'Absolute Silence', desc: 'You move through the world without sound. You automatically succeed on all Stealth checks based on sound. Your footsteps cannot be heard by any natural or magical means unless you choose otherwise.' },
      { id: 'ste-c2', branch: 'c', name: 'Master of Camouflage', desc: 'You can hide anywhere. You have advantage on all Stealth checks regardless of environment. You can attempt to hide even when only lightly obscured or under mild scrutiny.' },
    ],
    finale: { name: 'Wraith', desc: 'You have transcended the mortal art of stealth. You can become invisible at will as a bonus action. This invisibility ends only if you attack, cast a spell, or choose to end it. While invisible, you cannot be detected by magical means unless the spell specifically targets invisible creatures.' }
  },
  {
    id: 'survival', name: 'Survival', subtitle: 'Track, forage, and endure the harsh realities beyond the city walls.', type: 'skill',
    base: { name: 'Wilderness Expert', desc: 'The harshest environments hold no mystery for you. You gain proficiency in Survival. You and your party always find sufficient food, water, and shelter in any environment, and extreme weather only imposes disadvantage on checks rather than automatic failure.' },
    tier1: [
      { id: 'sur-a', branch: 'a', name: 'Expert Tracker', desc: 'You can follow any trail. You have advantage on Survival checks to track creatures. You can track through any terrain and follow trails up to 7 days old. Magically obscured trails only impose disadvantage rather than making tracking impossible.' },
      { id: 'sur-b', branch: 'b', name: 'Elemental Endurance', desc: 'Nature\'s extremes cannot break you. You have resistance to cold and fire damage. You are immune to the effects of extreme heat and extreme cold, and you need only half the food and water a normal creature requires.' },
      { id: 'sur-c', branch: 'c', name: 'Resourceful', desc: 'You make the most of whatever the world offers. During a short rest in a natural environment, you can forage sufficient material to create one of: a healer\'s kit use, a torch and fire, rope from vines (50 ft), or a simple weapon.' },
    ],
    tier2: [
      { id: 'sur-a2', branch: 'a', name: 'Bloodhound', desc: 'No quarry can escape you. You can track any creature that has passed through an area within the past 30 days, including through magically obscured trails (DC 25 Survival). You know the exact number of creatures and their general size.' },
      { id: 'sur-b2', branch: 'b', name: 'Iron Body', desc: 'Your body has adapted to endure anything. You are immune to disease and have advantage on saving throws against poison. You can survive on a quarter of the normal food and water requirement indefinitely.' },
      { id: 'sur-c2', branch: 'c', name: 'Wilderness Smith', desc: 'You can craft anything from what nature provides. During a long rest in a natural environment, you can craft: basic armor (AC 13), a shield, any simple weapon, or a week\'s worth of rations. These items have the same properties as their standard counterparts.' },
    ],
    finale: { name: 'Apex Survivor', desc: 'You are at home in any environment, under any conditions. You have advantage on all Survival checks. You are immune to disease, poison, extreme weather, and environmental hazards. Once per long rest, you can perfectly recall the layout of any terrain you have passed through in the last 30 days and instantly know the optimal path through it, including the locations of any creatures that have recently used it.' }
  }
];

// ═══════════════════════════════════════════════
// STATE
// purchased: Map of treeId -> Set of purchased node ids
// ═══════════════════════════════════════════════
const purchased = {};
TREES.forEach(t => purchased[t.id] = new Set());

// proficient: Set of tree ids where character has skill proficiency
const proficient = new Set();

// Skill trees that can have proficiency
const SKILL_TREE_IDS = TREES.filter(t => t.type === 'skill').map(t => t.id);

let currentTree = null;

function isBaseFreeThroughProf(treeId) {
  return proficient.has(treeId);
}

function totalSpent() {
  // Only count points that were actively purchased (not free from proficiency)
  return Object.entries(purchased).reduce((sum, [treeId, s]) => {
    let count = s.size;
    // If base is purchased and this tree has proficiency, don't count the base
    if (s.has('base') && isBaseFreeThroughProf(treeId)) count -= 1;
    return sum + count;
  }, 0);
}

function treeSpent(treeId) {
  let count = purchased[treeId].size;
  if (purchased[treeId].has('base') && isBaseFreeThroughProf(treeId)) count -= 1;
  return count;
}

function toggleProficiency(treeId) {
  if (proficient.has(treeId)) {
    proficient.delete(treeId);
    // If base was unlocked via proficiency and nothing else is purchased, remove base
    const ps = purchased[treeId];
    if (ps.has('base') && ps.size === 1) {
      ps.delete('base');
    } else if (ps.has('base')) {
      // Base remains but now costs a point — keep it, just recount
    }
  } else {
    proficient.add(treeId);
    // Auto-unlock base for free
    purchased[treeId].add('base');
  }
  updatePointBar();
  refreshMainCards();
  if (currentTree && currentTree.id === treeId) renderTree();
  refreshProfChips();
}

function refreshProfChips() {
  document.querySelectorAll('.prof-chip').forEach(chip => {
    const tid = chip.dataset.treeid;
    if (proficient.has(tid)) chip.classList.add('active');
    else chip.classList.remove('active');
    chip.querySelector('input').checked = proficient.has(tid);
  });
}

function buildProfPanel() {
  const grid = document.getElementById('profGrid');
  grid.innerHTML = '';
  TREES.filter(t => t.type === 'skill').forEach(tree => {
    const chip = document.createElement('label');
    chip.className = 'prof-chip';
    chip.dataset.treeid = tree.id;
    chip.innerHTML = `<input type="checkbox" onchange="toggleProficiency('${tree.id}')"> ${tree.name}`;
    grid.appendChild(chip);
  });
}

// ═══════════════════════════════════════════════
// MAIN VIEW
// ═══════════════════════════════════════════════
function buildMainView() {
  const featured = TREES.filter(t => t.type === 'featured');
  const skills = TREES.filter(t => t.type === 'skill');

  const fg = document.getElementById('featuredGrid');
  fg.innerHTML = '';
  featured.forEach(t => fg.appendChild(makeTalentCard(t)));

  const sg = document.getElementById('skillsGrid');
  sg.innerHTML = '';
  skills.forEach(t => sg.appendChild(makeTalentCard(t)));
  buildProfPanel();
}

function makeTalentCard(tree) {
  const div = document.createElement('div');
  const spent = treeSpent(tree.id);
  div.className = 'talent-card' + (spent > 0 ? ' has-points' : '');
  div.onclick = () => showDetail(tree.id);
  div.innerHTML = `
    <div class="tc-name">${tree.name}</div>
    <div class="tc-spent ${spent > 0 ? 'nonzero' : ''}">${spent > 0 ? spent + ' pt' + (spent !== 1 ? 's' : '') + ' spent' : 'No points spent'}</div>
  `;
  return div;
}

function refreshMainCards() {
  document.querySelectorAll('#featuredGrid .talent-card, #skillsGrid .talent-card').forEach((card, i) => {
    const tree = [...TREES.filter(t => t.type === 'featured'), ...TREES.filter(t => t.type === 'skill')][i];
    const spent = treeSpent(tree.id);
    card.className = 'talent-card' + (spent > 0 ? ' has-points' : '');
    const spentEl = card.querySelector('.tc-spent');
    spentEl.className = 'tc-spent' + (spent > 0 ? ' nonzero' : '');
    spentEl.textContent = spent > 0 ? spent + ' pt' + (spent !== 1 ? 's' : '') + ' spent' : 'No points spent';
  });
}

// ═══════════════════════════════════════════════
// DETAIL VIEW
// ═══════════════════════════════════════════════
function showDetail(treeId) {
  currentTree = TREES.find(t => t.id === treeId);
  document.getElementById('mainView').style.display = 'none';
  document.getElementById('detailView').style.display = 'block';
  document.getElementById('detailTitle').textContent = currentTree.name;
  document.getElementById('detailSubtitle').textContent = currentTree.subtitle;
  renderTree();
  document.querySelector('.point-bar').scrollIntoView({ behavior: 'smooth' });
}

function showMain() {
  currentTree = null;
  document.getElementById('detailView').style.display = 'none';
  document.getElementById('mainView').style.display = 'block';
  refreshMainCards();
  updatePointBar();
}

function renderTree() {
  const tree = currentTree;
  const ps = purchased[tree.id];
  const area = document.getElementById('treeArea');
  area.innerHTML = '';

  const hasAnyTier2 = tree.tier2.some(n => ps.has(n.id));

  const wrap = document.createElement('div');
  wrap.style.position = 'relative';
  area.appendChild(wrap);

  const rowBase = makeLevel([makeTreeNode(tree.id, 'base', tree.base.name, tree.base.desc, 1, 'base-node', ps, tree)]);
  rowBase.id = 'row-base';
  wrap.appendChild(rowBase);

  const gap1 = document.createElement('div'); gap1.style.height = '48px'; wrap.appendChild(gap1);

  const rowT1 = makeLevel(tree.tier1.map(n => makeTreeNode(tree.id, n.id, n.name, n.desc, 1, '', ps, tree, n.branch)));
  rowT1.id = 'row-t1';
  wrap.appendChild(rowT1);

  const gap2 = document.createElement('div'); gap2.style.height = '48px'; wrap.appendChild(gap2);

  const rowT2 = makeLevel(tree.tier2.map(n => {
    const parent = tree.tier1.find(t => t.branch === n.branch);
    const prereqMet = parent && ps.has(parent.id);
    return makeTreeNode(tree.id, n.id, n.name, n.desc, 1, '', ps, tree, n.branch, prereqMet);
  }));
  rowT2.id = 'row-t2';
  wrap.appendChild(rowT2);

  const gap3 = document.createElement('div'); gap3.style.height = '48px'; wrap.appendChild(gap3);

  const rowFin = makeLevel([makeTreeNode(tree.id, 'finale', tree.finale.name, tree.finale.desc, 2, 'finale-node', ps, tree, '', hasAnyTier2)]);
  rowFin.id = 'row-fin';
  wrap.appendChild(rowFin);

  requestAnimationFrame(() => drawConnectors(wrap, tree, ps));
}

function drawConnectors(wrap, tree, ps) {
  const old = wrap.querySelector('svg.tree-svg');
  if (old) old.remove();

  const wrapRect = wrap.getBoundingClientRect();

  function cx(el) {
    const r = el.getBoundingClientRect();
    return r.left - wrapRect.left + r.width / 2;
  }
  function bot(el) {
    const r = el.getBoundingClientRect();
    return { x: cx(el), y: r.bottom - wrapRect.top };
  }
  function top(el) {
    const r = el.getBoundingClientRect();
    return { x: cx(el), y: r.top - wrapRect.top };
  }

  const baseEl = wrap.querySelector('.base-node');
  const t1Els  = [...wrap.querySelectorAll('#row-t1 .tree-node')];
  const t2Els  = [...wrap.querySelectorAll('#row-t2 .tree-node')];
  const finEl  = wrap.querySelector('.finale-node');

  const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
  svg.classList.add('tree-svg');
  svg.style.cssText = 'position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;overflow:visible;';
  wrap.appendChild(svg);

  function line(x1, y1, x2, y2, active) {
    const l = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    l.setAttribute('x1', x1); l.setAttribute('y1', y1);
    l.setAttribute('x2', x2); l.setAttribute('y2', y2);
    l.setAttribute('stroke', active ? 'var(--arcane)' : 'rgba(124,79,196,0.18)');
    l.setAttribute('stroke-width', active ? '2.5' : '1.5');
    if (!active) l.setAttribute('stroke-dasharray', '4 3');
    svg.appendChild(l);
  }

  // Base → each Tier 1
  const baseBot = bot(baseEl);
  t1Els.forEach((el, i) => {
    const t = top(el);
    const active = ps.has('base') && ps.has(tree.tier1[i].id);
    line(baseBot.x, baseBot.y, t.x, t.y, active);
  });

  // Each Tier 1 → its Tier 2
  t1Els.forEach((t1El, i) => {
    const t2El = t2Els[i];
    if (!t2El) return;
    const active = ps.has(tree.tier1[i].id) && ps.has(tree.tier2[i].id);
    line(bot(t1El).x, bot(t1El).y, top(t2El).x, top(t2El).y, active);
  });

  // Each Tier 2 → Finale
  const finTop = top(finEl);
  t2Els.forEach((t2El, i) => {
    const active = ps.has(tree.tier2[i].id) && ps.has('finale');
    line(bot(t2El).x, bot(t2El).y, finTop.x, finTop.y, active);
  });
}

function makeTierLabel(text) {
  const d = document.createElement('div');
  d.className = 'tier-label';
  d.textContent = text;
  return d;
}

function makeDivider() {
  const d = document.createElement('div');
  d.className = 'tree-connector';
  return d;
}

function makeLevel(nodes) {
  const d = document.createElement('div');
  d.className = 'tree-level';
  nodes.forEach(n => d.appendChild(n));
  return d;
}

function makeTreeNode(treeId, nodeId, name, desc, cost, extraClass, ps, tree, branch, prereqOverride) {
  const isPurchased = ps.has(nodeId);
  const isBase = nodeId === 'base';
  const isFreeBase = isBase && isBaseFreeThroughProf(treeId);

  let prereqMet;
  if (isBase) {
    prereqMet = true;
  } else if (prereqOverride !== undefined) {
    prereqMet = prereqOverride;
  } else {
    prereqMet = ps.has('base');
  }

  let state = 'locked';
  if (isPurchased) state = 'purchased';
  else if (prereqMet) state = 'available';

  const div = document.createElement('div');
  let classes = `tree-node ${state} ${extraClass}`;
  if (isFreeBase && isPurchased) classes += ' base-free';
  div.className = classes;

  // All nodes (including base) are clickable
  div.onclick = () => handleNodeClick(treeId, nodeId, tree, branch);

  let label = '';
  if (isBase) label = '<span class="tn-label">Foundation</span>';
  else if (extraClass.includes('finale')) label = '<span class="tn-label">Finale</span>';
  else if (branch) label = `<span class="tn-label">Path ${branch.toUpperCase()}</span>`;

  let costHtml = '';

  if (isBase && isFreeBase) {
  // Base talent unlocked via proficiency
  costHtml = `<span class="tn-cost tn-cost-status tn-cost-proficient">Proficient</span>`;
  } else if (isPurchased) {
  // Any purchased talent (including non-base)
  costHtml = `<span class="tn-cost tn-cost-status tn-cost-acquired">Acquired</span>`;
  } else {
  // Normal unpurchased node
  costHtml = `<span class="tn-cost">${cost} pt</span>`;
  }

  div.innerHTML = `
    ${label}
    <div class="tn-name">${name}</div>
    <div class="tn-desc">${desc}</div>
    ${costHtml}
  `;
  return div;
}

function handleNodeClick(treeId, nodeId, tree, branch) {
  const ps = purchased[treeId];

  const isTier1 = tree.tier1.some(n => n.id === nodeId);
  const isTier2 = tree.tier2.some(n => n.id === nodeId);
  const isFinale = nodeId === 'finale';
  const isBase = nodeId === 'base';
  const isFreeBase = isBase && isBaseFreeThroughProf(treeId);

  if (ps.has(nodeId)) {
    // ── REFUND ──────────────────────────────────

    if (isBase) {
      // Can't refund base if locked via proficiency
      if (isFreeBase) { flash('Remove your proficiency tick to unlearn this foundation.'); return; }
      // Can only refund base if nothing else is purchased
      if (ps.size > 1) { flash('Refund all other talents first.'); return; }
      ps.delete(nodeId);

    } else if (isTier1) {
      // Can't refund Tier 1 if its Tier 2 child is still purchased
      const tier2Child = tree.tier2.find(n => n.branch === branch);
      if (tier2Child && ps.has(tier2Child.id)) {
        flash('Refund the Tier II talent in this path first.');
        return;
      }
      ps.delete(nodeId);

    } else if (isTier2) {
      // Can refund a Tier 2 even if finale is purchased,
      // as long as at least one OTHER Tier 2 remains after this refund
      if (ps.has('finale')) {
        const otherTier2Remaining = tree.tier2.some(n => n.id !== nodeId && ps.has(n.id));
        if (!otherTier2Remaining) {
          flash('Refund the Finale first, or keep another Tier II talent.');
          return;
        }
      }
      ps.delete(nodeId);

    } else if (isFinale) {
      // Finale can always be refunded
      ps.delete(nodeId);
    }

  } else {
    // ── PURCHASE ────────────────────────────────

    if (isBase) {
      ps.add(nodeId);

    } else if (isTier1) {
      if (!ps.has('base')) { flash('Purchase the Foundation first.'); return; }
      ps.add(nodeId);

    } else if (isTier2) {
      const parent = tree.tier1.find(t => t.branch === branch);
      if (!parent || !ps.has(parent.id)) {
        flash('Purchase the Tier I talent in this path first.');
        return;
      }
      ps.add(nodeId);

    } else if (isFinale) {
      const anyTier2 = tree.tier2.some(n => ps.has(n.id));
      if (!anyTier2) { flash('Purchase at least one Tier II talent first.'); return; }
      ps.add(nodeId);
    }
  }

  updatePointBar();
  renderTree();
}

function flash(msg) {
  // Simple flash message
  let el = document.getElementById('flashMsg');
  if (!el) {
    el = document.createElement('div');
    el.id = 'flashMsg';
    el.style.cssText = 'position:fixed;top:80px;left:50%;transform:translateX(-50%);background:#2c1a0e;border:1px solid #c44;color:#c44;font-family:Cinzel,serif;font-size:0.8rem;padding:8px 20px;border-radius:3px;z-index:999;pointer-events:none;';
    document.body.appendChild(el);
  }
  el.textContent = msg;
  el.style.opacity = '1';
  clearTimeout(el._t);
  el._t = setTimeout(() => el.style.opacity = '0', 2000);
}

function updatePointBar() {
  const spent = totalSpent();
  document.getElementById('globalSpent').textContent = spent;
  const trees = spent === 1 ? 'talent' : ' ';
  document.getElementById('globalSub').textContent = `${trees}  `;
}

function resetAll() {
  TREES.forEach(t => purchased[t.id].clear());
  updatePointBar();
  if (currentTree) renderTree();
  else refreshMainCards();
}

// ── INIT ─────────────────────────────────────
buildMainView();
buildProfPanel();
updatePointBar();
</script>

<canvas id="runeCanvas"></canvas>
<script src="runes.js"></script>
</body>
</html>
